
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>The Ejabberd Socket Infrastructure - Hacking is great fun.</title>
  <meta name="author" content="Chi Zhang">

  
  <meta name="description" content="Welcome to my first blog about ejabberd source code hacking. In these series of blogs, I want to take notes about how the ejabberd works, and how to &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://eshock.github.io/ejabberd/blog/2012/05/23/ejabberd-notes-the-listener-infrastructure">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="/javascripts/ender.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="/atom.xml" rel="alternate" title="Hacking is great fun." type="application/atom+xml">
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  

</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Hacking is great fun.</a></h1>
  
    <h2>You can do anything you set your mind to.</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:eshock.github.io/ejabberd" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
  <li><a href="https://github.com/eshock">Repo</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">The Ejabberd Socket Infrastructure</h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-05-23T13:49:00+08:00" pubdate data-updated="true">May 23<span>rd</span>, 2012</time>
        
         | <a href="#disqus_thread">Comments</a>
        
      </p>
    
  </header>


<div class="entry-content"><p>Welcome to my first blog about ejabberd source code hacking. In these series of blogs, I want to take notes about how the <a href="http://www.ejabberd.im/">ejabberd</a> works, and how to hack it to get customized features.</p>

<p>The source code version in discussion is ejabberd 2.1.10 release, which is the latest stable version at this time.</p>

<h2>Intro</h2>

<p>The first step to source hacking is code reading. Ejabberd is a big project (with 80k+lines of erlang code), so it&rsquo;s impossible for us to understand it all at once. Like reading a book, we need to get the key idea first.</p>

<p>What is the key idea of this XMPP(Jabber) server, then? Let&rsquo;s review some of the key usages of a typical XMPP session:</p>

<ol>
<li>Alice started an XMPP client on her computer, which establishes a TCP connection to xmpp.example.org:5222.</li>
<li>The server authenticates the client by exchanging XML stanzas.</li>
<li>Alice uses the XMPP client to exchange messages/presences/iqs with the server, completing tasks such as instant messaging and presence notifying.</li>
</ol>


<p>The essential task of the server, then, is to listen on a specific port, wait for clients or other servers to connect to it, and then exchange information using specific data formats(in the XMPP&rsquo;s situation, XML stanzas).</p>

<p>That said, let&rsquo;s examine the listener/socket code of ejabberd first, throwing aside other features along the way.</p>

<p><em>Notice</em>: for the sake of clearity, I intentionally omitted a lot of code which are either unrelated to the topic discussed or only used for error handling.</p>

<h2>Binding listener ports</h2>

<p>In ejabberd, the whole server is packaged into a single OTP application.</p>

<p>The modules related to ejabberd&rsquo;s socket infrastructure are: ejabberd_listener, ejabberd_socket and ejabberd_receiver.</p>

<p>The ejabberd_listener listens on every port specified in the ejabberd configuration file, spawns a process for each port and then accepts the sockets. When it finishes, it starts ejabberd_socket which in turn starts two processes: ejabberd_receiver and logic module according to the config (ejabberd_c2s for 5222, for example). The ejabberd_receiver is responsible for receiving any incoming packets and then forwarding them to the logic module. The logic module parses and handles the packets, and sends responses and requests using the ejabberd_socket utils.</p>

<p>Let&rsquo;s start with the application module:</p>

<figure class='code'><figcaption><span>ejabberd_app.erl </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='erlang'><span class='line'><span class="nf">start</span><span class="p">(</span><span class="n">normal</span><span class="p">,</span> <span class="p">_</span><span class="nv">Args</span><span class="p">)</span> <span class="o">-&gt;</span>
</span><span class='line'>    <span class="nv">Sup</span> <span class="o">=</span> <span class="nn">ejabberd_sup</span><span class="p">:</span><span class="nf">start_link</span><span class="p">(),</span>
</span><span class='line'>    <span class="nn">ejabberd_listener</span><span class="p">:</span><span class="nf">start_listeners</span><span class="p">().</span>
</span></code></pre></td></tr></table></div></figure>


<p>In ejabberd_sup:start_link/0, ejabberd_listener:start_link/0 is invoked:</p>

<figure class='code'><figcaption><span>ejabberd_sup.erl </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='erlang'><span class='line'><span class="nf">init</span><span class="p">([])</span> <span class="o">-&gt;</span>
</span><span class='line'>    <span class="nv">Listener</span> <span class="o">=</span>
</span><span class='line'>    <span class="p">{</span><span class="n">ejabberd_listener</span><span class="p">,</span>
</span><span class='line'>     <span class="p">{</span><span class="n">ejabberd_listener</span><span class="p">,</span> <span class="n">start_link</span><span class="p">,</span> <span class="p">[]},</span>
</span><span class='line'>     <span class="n">permanent</span><span class="p">,</span>
</span><span class='line'>     <span class="n">infinity</span><span class="p">,</span>
</span><span class='line'>     <span class="n">supervisor</span><span class="p">,</span>
</span><span class='line'>     <span class="p">[</span><span class="n">ejabberd_listener</span><span class="p">]}.</span>
</span></code></pre></td></tr></table></div></figure>


<p>Inside ejabberd_listener:init/0, the tcp and udp ports are bound according to the config file:</p>

<figure class='code'><figcaption><span>ejabberd_listener.erl </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
</pre></td><td class='code'><pre><code class='erlang'><span class='line'><span class="nf">init</span><span class="p">(_)</span> <span class="o">-&gt;</span>
</span><span class='line'>    <span class="nn">ets</span><span class="p">:</span><span class="nf">new</span><span class="p">(</span><span class="n">listen_sockets</span><span class="p">,</span> <span class="p">[</span><span class="n">named_table</span><span class="p">,</span> <span class="n">public</span><span class="p">]),</span>
</span><span class='line'>    <span class="n">bind_tcp_ports</span><span class="p">(),</span>
</span><span class='line'>    <span class="p">{</span><span class="n">ok</span><span class="p">,</span> <span class="p">{</span> <span class="p">{</span><span class="n">one_for_one</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">1</span><span class="p">},</span> <span class="p">[]}}.</span>
</span><span class='line'>
</span><span class='line'><span class="nf">bind_tcp_ports</span><span class="p">()</span> <span class="o">-&gt;</span>
</span><span class='line'>    <span class="k">case</span> <span class="nn">ejabberd_config</span><span class="p">:</span><span class="nf">get_local_option</span><span class="p">(</span><span class="n">listen</span><span class="p">)</span> <span class="k">of</span>
</span><span class='line'>        <span class="nv">Ls</span> <span class="o">-&gt;</span>
</span><span class='line'>            <span class="nn">lists</span><span class="p">:</span><span class="nf">foreach</span><span class="p">(</span>
</span><span class='line'>              <span class="k">fun</span><span class="p">({</span><span class="nv">Port</span><span class="p">,</span> <span class="nv">Module</span><span class="p">,</span> <span class="nv">Opts</span><span class="p">})</span> <span class="o">-&gt;</span>
</span><span class='line'>                  <span class="n">bind_tcp_port</span><span class="p">(</span><span class="nv">Port</span><span class="p">,</span> <span class="nv">Module</span><span class="p">,</span> <span class="nv">Opts</span><span class="p">)</span>
</span><span class='line'>              <span class="k">end</span><span class="p">,</span>
</span><span class='line'>              <span class="nv">Ls</span><span class="p">)</span>
</span><span class='line'>    <span class="k">end</span><span class="p">.</span>
</span><span class='line'>
</span><span class='line'><span class="nf">bind_tcp_port</span><span class="p">(</span><span class="nv">PortIP</span><span class="p">,</span> <span class="nv">Module</span><span class="p">,</span> <span class="nv">RawOpts</span><span class="p">)</span> <span class="o">-&gt;</span>
</span><span class='line'>    <span class="c">%% portip has the following format: {5222, {0,0,0,0},tcp}</span>
</span><span class='line'>    <span class="p">{</span><span class="nv">Port</span><span class="p">,</span> <span class="nv">IPT</span><span class="p">,</span> <span class="nv">IPS</span><span class="p">,</span> <span class="nv">IPV</span><span class="p">,</span> <span class="nv">Proto</span><span class="p">,</span> <span class="nv">OptsClean</span><span class="p">}</span> <span class="o">=</span> <span class="n">parse_listener_portip</span><span class="p">(</span><span class="nv">PortIP</span><span class="p">,</span> <span class="nv">RawOpts</span><span class="p">),</span>
</span><span class='line'>    <span class="p">_</span><span class="nv">Opts</span><span class="p">,</span> <span class="nv">SockOpts</span><span class="p">}</span> <span class="o">=</span> <span class="n">prepare_opts</span><span class="p">(</span><span class="nv">IPT</span><span class="p">,</span> <span class="nv">IPV</span><span class="p">,</span> <span class="nv">OptsClean</span><span class="p">),</span>
</span><span class='line'>    <span class="c">%% save parsed listener options into ets table</span>
</span><span class='line'>    <span class="n">listen_tcp</span><span class="p">(</span><span class="nv">PortIP</span><span class="p">,</span> <span class="nv">Module</span><span class="p">,</span> <span class="nv">SockOpts</span><span class="p">,</span> <span class="nv">Port</span><span class="p">,</span> <span class="nv">IPS</span><span class="p">).</span>
</span><span class='line'>
</span><span class='line'><span class="nf">listen_tcp</span><span class="p">(</span><span class="nv">PortIP</span><span class="p">,</span> <span class="nv">Module</span><span class="p">,</span> <span class="nv">SockOpts</span><span class="p">,</span> <span class="nv">Port</span><span class="p">,</span> <span class="nv">IPS</span><span class="p">)</span> <span class="o">-&gt;</span>
</span><span class='line'>    <span class="nn">gen_tcp</span><span class="p">:</span><span class="nf">listen</span><span class="p">(</span><span class="nv">Port</span><span class="p">,</span> <span class="p">[</span><span class="n">binary</span><span class="p">,</span>
</span><span class='line'>                <span class="p">{</span><span class="n">packet</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
</span><span class='line'>                <span class="p">{</span><span class="n">active</span><span class="p">,</span> <span class="n">false</span><span class="p">},</span>
</span><span class='line'>                <span class="p">{</span><span class="n">reuseaddr</span><span class="p">,</span> <span class="n">true</span><span class="p">},</span>
</span><span class='line'>                <span class="p">{</span><span class="n">nodelay</span><span class="p">,</span> <span class="n">true</span><span class="p">},</span>
</span><span class='line'>                <span class="p">{</span><span class="n">send_timeout</span><span class="p">,</span> <span class="o">?</span><span class="nv">TCP_SEND_TIMEOUT</span><span class="p">},</span>
</span><span class='line'>                <span class="p">{</span><span class="n">keepalive</span><span class="p">,</span> <span class="n">true</span><span class="p">}</span> <span class="p">|</span>
</span><span class='line'>                <span class="nv">SockOpts</span><span class="p">]).</span>
</span></code></pre></td></tr></table></div></figure>


<p>After ejabberd_listener:init/0 is finished, all the ports specified in the config file are opened(in the listening state), but not accepting any incoming connections yet.</p>

<h2>Accept incoming connections</h2>

<p>Next, the sockets start accepting incoming connections in ejabberd_listener:start_listeners/0:</p>

<figure class='code'><figcaption><span>ejabberd_listener.erl </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
</pre></td><td class='code'><pre><code class='erlang'><span class='line'><span class="nf">start_listeners</span><span class="p">()</span> <span class="o">-&gt;</span>
</span><span class='line'>    <span class="c">%% load listeners config from ets table</span>
</span><span class='line'>    <span class="nv">Ls2</span> <span class="o">=</span> <span class="nn">lists</span><span class="p">:</span><span class="nf">map</span><span class="p">(</span>
</span><span class='line'>        <span class="k">fun</span><span class="p">({</span><span class="nv">Port</span><span class="p">,</span> <span class="nv">Module</span><span class="p">,</span> <span class="nv">Opts</span><span class="p">})</span> <span class="o">-&gt;</span>
</span><span class='line'>            <span class="n">start_listener</span><span class="p">(</span><span class="nv">Port</span><span class="p">,</span> <span class="nv">Module</span><span class="p">,</span> <span class="nv">Opts</span><span class="p">)</span>
</span><span class='line'>        <span class="k">end</span>
</span><span class='line'>    <span class="k">end</span><span class="p">,</span> <span class="nv">Listeners</span><span class="p">).</span>
</span><span class='line'>
</span><span class='line'><span class="nf">start_listener</span><span class="p">(</span><span class="nv">Port</span><span class="p">,</span> <span class="nv">Module</span><span class="p">,</span> <span class="nv">Opts</span><span class="p">)</span> <span class="o">-&gt;</span>
</span><span class='line'>    <span class="nv">ChildSpec</span> <span class="o">=</span> <span class="p">{</span><span class="nv">Port</span><span class="p">,</span>
</span><span class='line'>         <span class="p">{</span><span class="o">?</span><span class="nv">MODULE</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="p">[</span><span class="nv">Port</span><span class="p">,</span> <span class="nv">Module</span><span class="p">,</span> <span class="nv">Opts</span><span class="p">]},</span>
</span><span class='line'>         <span class="n">transient</span><span class="p">,</span>
</span><span class='line'>         <span class="n">brutal_kill</span><span class="p">,</span>
</span><span class='line'>         <span class="n">worker</span><span class="p">,</span>
</span><span class='line'>         <span class="p">[</span><span class="o">?</span><span class="nv">MODULE</span><span class="p">]},</span>
</span><span class='line'>    <span class="nn">supervisor</span><span class="p">:</span><span class="nf">start_child</span><span class="p">(</span><span class="n">ejabberd_listeners</span><span class="p">,</span> <span class="nv">ChildSpec</span><span class="p">).</span>
</span><span class='line'>
</span><span class='line'><span class="nf">start</span><span class="p">(</span><span class="nv">Port</span><span class="p">,</span> <span class="nv">Module</span><span class="p">,</span> <span class="nv">Opts</span><span class="p">)</span> <span class="o">-&gt;</span>
</span><span class='line'>    <span class="nn">proc_lib</span><span class="p">:</span><span class="nf">start_link</span><span class="p">(</span><span class="o">?</span><span class="nv">MODULE</span><span class="p">,</span> <span class="n">init</span><span class="p">,</span> <span class="p">[</span><span class="nv">Port</span><span class="p">,</span> <span class="nv">Module</span><span class="p">,</span> <span class="nv">Opts</span><span class="p">]).</span>
</span><span class='line'>
</span><span class='line'><span class="nf">init</span><span class="p">(</span><span class="nv">PortIP</span><span class="p">,</span> <span class="nv">Module</span><span class="p">,</span> <span class="nv">RawOpts</span><span class="p">)</span> <span class="o">-&gt;</span>
</span><span class='line'>    <span class="p">{</span><span class="nv">Port</span><span class="p">,</span> <span class="nv">IPT</span><span class="p">,</span> <span class="nv">IPS</span><span class="p">,</span> <span class="nv">IPV</span><span class="p">,</span> <span class="nv">Proto</span><span class="p">,</span> <span class="nv">OptsClean</span><span class="p">}</span> <span class="o">=</span> <span class="n">parse_listener_portip</span><span class="p">(</span><span class="nv">PortIP</span><span class="p">,</span> <span class="nv">RawOpts</span><span class="p">),</span>
</span><span class='line'>    <span class="p">{</span><span class="nv">Opts</span><span class="p">,</span> <span class="nv">SockOpts</span><span class="p">}</span> <span class="o">=</span> <span class="n">prepare_opts</span><span class="p">(</span><span class="nv">IPT</span><span class="p">,</span> <span class="nv">IPV</span><span class="p">,</span> <span class="nv">OptsClean</span><span class="p">),</span>
</span><span class='line'>    <span class="n">init_tcp</span><span class="p">(</span><span class="nv">PortIP</span><span class="p">,</span> <span class="nv">Module</span><span class="p">,</span> <span class="nv">Opts</span><span class="p">,</span> <span class="nv">SockOpts</span><span class="p">,</span> <span class="nv">Port</span><span class="p">,</span> <span class="nv">IPS</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="nf">init_tcp</span><span class="p">(</span><span class="nv">PortIP</span><span class="p">,</span> <span class="nv">Module</span><span class="p">,</span> <span class="nv">Opts</span><span class="p">,</span> <span class="nv">SockOpts</span><span class="p">,</span> <span class="nv">Port</span><span class="p">,</span> <span class="nv">IPS</span><span class="p">)</span> <span class="o">-&gt;</span>
</span><span class='line'>    <span class="nv">ListenSocket</span> <span class="o">=</span> <span class="n">listen_tcp</span><span class="p">(</span><span class="nv">PortIP</span><span class="p">,</span> <span class="nv">Module</span><span class="p">,</span> <span class="nv">SockOpts</span><span class="p">,</span> <span class="nv">Port</span><span class="p">,</span> <span class="nv">IPS</span><span class="p">),</span>
</span><span class='line'>    <span class="nn">proc_lib</span><span class="p">:</span><span class="nf">init_ack</span><span class="p">({</span><span class="n">ok</span><span class="p">,</span> <span class="n">self</span><span class="p">()}),</span>
</span><span class='line'>    <span class="n">accept</span><span class="p">(</span><span class="nv">ListenSocket</span><span class="p">,</span> <span class="nv">Module</span><span class="p">,</span> <span class="nv">Opts</span><span class="p">).</span>
</span><span class='line'>
</span><span class='line'><span class="nf">accept</span><span class="p">(</span><span class="nv">ListenSocket</span><span class="p">,</span> <span class="nv">Module</span><span class="p">,</span> <span class="nv">Opts</span><span class="p">)</span> <span class="o">-&gt;</span>
</span><span class='line'>    <span class="k">case</span> <span class="nn">gen_tcp</span><span class="p">:</span><span class="nf">accept</span><span class="p">(</span><span class="nv">ListenSocket</span><span class="p">)</span> <span class="k">of</span>
</span><span class='line'>    <span class="p">{</span><span class="n">ok</span><span class="p">,</span> <span class="nv">Socket</span><span class="p">}</span> <span class="o">-&gt;</span>
</span><span class='line'>        <span class="nn">ejabberd_socket</span><span class="p">:</span><span class="nf">start</span><span class="p">(</span><span class="nv">Module</span><span class="p">,</span> <span class="n">gen_tcp</span><span class="p">,</span> <span class="nv">Socket</span><span class="p">,</span> <span class="nv">Opts</span><span class="p">),</span>
</span><span class='line'>        <span class="n">accept</span><span class="p">(</span><span class="nv">ListenSocket</span><span class="p">,</span> <span class="nv">Module</span><span class="p">,</span> <span class="nv">Opts</span><span class="p">);</span>
</span><span class='line'>    <span class="p">{</span><span class="n">error</span><span class="p">,</span> <span class="nv">Reason</span><span class="p">}</span> <span class="o">-&gt;</span>
</span><span class='line'>        <span class="n">accept</span><span class="p">(</span><span class="nv">ListenSocket</span><span class="p">,</span> <span class="nv">Module</span><span class="p">,</span> <span class="nv">Opts</span><span class="p">)</span>
</span><span class='line'>    <span class="k">end</span><span class="p">.</span>
</span></code></pre></td></tr></table></div></figure>


<p>As we see the code above, the start_listeners/0 call spawns a new process for each listened ports, and then link it to the ejabberd_listeners supervisor, which is started in ejabberd_listener:start_link/0. This may seem odd to you at first, as it DOES for me, since normally a supervisor&rsquo;s callbacks and its workers&#8217; callbacks ought to be put in separate modules. Don&rsquo;t write code like that; it causes confusions.</p>

<p>If you are careful enough, you might notice that the sockets are listened twice(once in bind_tcp_ports/0, once in start_listeners/0). I am not sure why it is implemented that way; it works perfectly if I removed one of them.</p>

<h2>Start handling requests</h2>

<p>Anyway, let&rsquo;s continue to see what happens when a socket is accepted:</p>

<figure class='code'><figcaption><span>ejabberd_socket.erl </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='erlang'><span class='line'><span class="nf">start</span><span class="p">(</span><span class="nv">Module</span><span class="p">,</span> <span class="nv">SockMod</span><span class="p">,</span> <span class="nv">Socket</span><span class="p">,</span> <span class="nv">Opts</span><span class="p">)</span> <span class="o">-&gt;</span>
</span><span class='line'>    <span class="nv">ReceiverMod</span> <span class="o">=</span> <span class="n">ejabberd_receiver</span><span class="p">,</span>  <span class="c">%% see explanation</span>
</span><span class='line'>    <span class="nv">RecPid</span> <span class="o">=</span> <span class="nv">ReceiverMod</span><span class="p">:</span><span class="nf">start</span><span class="p">(</span><span class="nv">Socket</span><span class="p">,</span> <span class="nv">SockMod</span><span class="p">,</span> <span class="n">none</span><span class="p">,</span> <span class="nv">MaxStanzaSize</span><span class="p">),</span>
</span><span class='line'>    <span class="nv">SocketData</span> <span class="o">=</span> <span class="nl">#socket_state</span><span class="p">{</span><span class="n">sockmod</span> <span class="o">=</span> <span class="nv">SockMod</span><span class="p">,</span>
</span><span class='line'>                   <span class="n">socket</span> <span class="o">=</span> <span class="nv">Socket</span><span class="p">,</span>
</span><span class='line'>                   <span class="n">receiver</span> <span class="o">=</span> <span class="nv">RecPid</span><span class="p">},</span>
</span><span class='line'>    <span class="k">case</span> <span class="nv">Module</span><span class="p">:</span><span class="nf">start</span><span class="p">({</span><span class="o">?</span><span class="nv">MODULE</span><span class="p">,</span> <span class="nv">SocketData</span><span class="p">},</span> <span class="nv">Opts</span><span class="p">)</span> <span class="k">of</span>
</span><span class='line'>        <span class="p">{</span><span class="n">ok</span><span class="p">,</span> <span class="nv">Pid</span><span class="p">}</span> <span class="o">-&gt;</span>
</span><span class='line'>            <span class="nv">SockMod</span><span class="p">:</span><span class="nf">controlling_process</span><span class="p">(</span><span class="nv">Socket</span><span class="p">,</span> <span class="nv">Receiver</span><span class="p">)</span> <span class="k">of</span>
</span><span class='line'>            <span class="nv">ReceiverMod</span><span class="p">:</span><span class="nf">become_controller</span><span class="p">(</span><span class="nv">Receiver</span><span class="p">,</span> <span class="nv">Pid</span><span class="p">);</span>
</span><span class='line'>        <span class="p">{</span><span class="n">error</span><span class="p">,</span> <span class="p">_</span><span class="nv">Reason</span><span class="p">}</span> <span class="o">-&gt;</span>
</span><span class='line'>            <span class="nv">ReceiverMod</span><span class="p">:</span><span class="nf">close</span><span class="p">(</span><span class="nv">Receiver</span><span class="p">);</span>
</span><span class='line'>    <span class="k">end</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<p>When a new socket is accepted, ejabberd_socket:start/4 is invoked to handle the socket events. ejabberd (brightly) splitted this task into two subtasks: one is to handle all the data transmition(sending and receiving, encapsulating the low-level socket implementation), the other is to parse and handle the message corresponding to the data. Hence, as we see here, a receiver process (ReceiverMod) and a logic handling process (Module) are spawned. The receiver module defaults to ejabberd_receiver, which receives XML stanzas and forwards the stanzas to the logic module. The logic module, on the other hand, may be ejabberd_c2s.erl or ejabberd_s2s depending for different tasks.</p>

<p>What &lsquo;SockMod:controlling_process(Socket, Receiver)&rsquo; does is to direct all data sent to the socket to the receiver mod, which then can handle all the incoming data. After the logic module starts, &lsquo;ReceiverMod:become_controller(Receiver, Pid)&rsquo; is called to let the receiver know where to forward incoming message to.</p>

<p>In a word, ejabberd starts a receiver and a handler when a socket is accepted, the receiver handles all incoming data, does some preprocessing(such as parsing the XML) and forward the message to the handler, the handler decides how to handle the message, and (maybe) use the ejabberd_socket util to send response data. If you want to extend the ejabberd to use other protocols than XMPP: this is the place to start. Write a customized receiver module to parse the protocol, a customized handler module to handle all the requests and you are done. More on this topic later.</p>

<h2>To sum up</h2>

<p>We have taken a quick tour through the socket infrastructure in ejabberd. We learned that the ejabberd uses three modules: ejabberd_listener, ejabberd_socket and ejabberd_receiver to handle all the socket related stuff. ejabberd_listener binds and listens on ports, ejabberd_socket starts the receiver and the handler, and provides utils for outgoing data, the receiver handles and parses all incoming data, and forwards messages to the logic module. The logics, on the other handle, are handled by logic modules accroding to the config file. There are, however, many things that we left out, including:</p>

<ol>
<li>customization of receiver/logic modules.</li>
<li>congestion control (shapers).</li>
<li>how the logic modules interacts with the socket infrastructure.</li>
</ol>


<p>So get your hands on the code piece by piece, make discoveries, and have fun! :)</p>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Chi Zhang</span></span>

      








  


<time datetime="2012-05-23T13:49:00+08:00" pubdate data-updated="true">May 23<span>rd</span>, 2012</time>
      

<span class="categories">
  
    <a class='category' href='/blog/categories/ejabberd/'>ejabberd</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  <a href="http://twitter.com/share" class="twitter-share-button" data-url="http://eshock.github.io/ejabberd/blog/2012/05/23/ejabberd-notes-the-listener-infrastructure/" data-via="xia0pang" data-counturl="http://eshock.github.io/ejabberd/blog/2012/05/23/ejabberd-notes-the-listener-infrastructure/" >Tweet</a>
  
  
  <div class="g-plusone" data-size="medium"></div>
  
  
    <div class="fb-like" data-send="true" data-width="450" data-show-faces="false"></div>
  
</div>

    
    <p class="meta">
      
      
        <a class="basic-alignment right" href="/blog/2012/05/25/writing-a-simple-echo-service-module/" title="Next Post: Writing a Simple Echo Service Module">Writing a Simple Echo Service Module &raquo;</a>
      
    </p>
  </footer>
</article>

  <section>
    <h1>Comments</h1>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
  </section>

</div>

<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2012/06/06/the-architecture-of-ejabberd/">The Architecture of Ejabberd</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/05/29/more-on-echo-service-using-tls-and-xml-streams/">More on Echo Service: Using TLS and XML Streams</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/05/25/writing-a-simple-echo-service-module/">Writing a Simple Echo Service Module</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/05/23/ejabberd-notes-the-listener-infrastructure/">The Ejabberd Socket Infrastructure</a>
      </li>
    
  </ul>
</section>





  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2013 - Chi Zhang -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'eshockgithubio';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://eshock.github.io/ejabberd/blog/2012/05/23/ejabberd-notes-the-listener-infrastructure/';
        var disqus_url = 'http://eshock.github.io/ejabberd/blog/2012/05/23/ejabberd-notes-the-listener-infrastructure/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>



<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) {return;}
  js = d.createElement(s); js.id = id;
  js.src = "//connect.facebook.net/en_US/all.js#appId=212934732101925&xfbml=1";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>



  <script type="text/javascript">
    (function() {
      var script = document.createElement('script'); script.type = 'text/javascript'; script.async = true;
      script.src = 'https://apis.google.com/js/plusone.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(script, s);
    })();
  </script>



  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
